<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW å½±ç‰‡é€£çµæå–å™¨ - å‹¾é¸å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .scanning { animation: pulse 1.5s infinite; }
        /* è‡ªè¨‚æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; rounded: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
        /* éš±è—åŸç”Ÿæ‰“å‹¾æ¡†æ™‚çš„é»æ“Šç‰¹æ•ˆ */
        .video-cb { accent-color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-md p-8 mb-6 border border-gray-100 relative">
            <!-- æ–°å¢æ‰‹å‹•é–‹å•Ÿèªªæ˜çš„æŒ‰éˆ• -->
            <button id="showHelpBtn" class="absolute top-4 right-4 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 py-1.5 px-3 rounded-lg text-sm font-bold transition-colors flex items-center gap-1 shadow-sm border border-indigo-100">
                ğŸ“– ä½¿ç”¨èªªæ˜
            </button>
            
            <h1 class="text-3xl font-bold text-slate-800 mb-2 text-center mt-2">JW å½±ç‰‡é€£çµæå–å™¨</h1>
            <p class="text-slate-500 text-center mb-8">æ”¯æ´å‹•æ…‹èªè¨€è½‰æ›èˆ‡è‡ªè¨‚å‹¾é¸è¤‡è£½</p>
            
            <div class="space-y-4">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-slate-700">åˆ†é¡é é¢ç¶²å€ï¼š</label>
                    <div class="relative">
                        <input type="text" id="urlInput" 
                            placeholder="è²¼ä¸Šç¶²å€ï¼Œå¦‚ï¼š.../categories/StudioMonthlyPrograms" 
                            class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm">
                    </div>
                </div>

                <div class="flex flex-wrap justify-center gap-4">
                    <button id="fetchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-xl transition-all shadow-lg flex items-center gap-2">
                        ç«‹å³æå–å½±ç‰‡
                    </button>
                </div>
            </div>
        </div>

        <div id="statusBox" class="hidden mb-6 p-4 rounded-xl text-center font-medium border"></div>
        
        <!-- æ“ä½œé¢æ¿ (å…¨é¸ã€å€é–“é¸å– & è¤‡è£½é¸å–é …ç›®) -->
        <div id="actionPanel" class="hidden flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4 sticky top-4 z-10">
            <div class="flex flex-wrap items-center justify-center gap-4 w-full md:w-auto">
                <label class="flex items-center gap-2 cursor-pointer text-slate-700 font-bold select-none hover:text-indigo-600 transition-colors">
                    <input type="checkbox" id="selectAllCheckbox" class="w-5 h-5 rounded border-slate-300 video-cb cursor-pointer">
                    å…¨é¸
                </label>
                <div class="hidden md:block h-6 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2 text-sm bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200 shadow-inner">
                    <span class="text-slate-600 font-bold whitespace-nowrap">å€é–“ï¼š</span>
                    <input type="number" id="rangeStart" placeholder="1" class="w-14 px-1 py-1 border border-slate-300 rounded text-center focus:ring-2 focus:ring-indigo-500 outline-none" min="1">
                    <span class="text-slate-400 font-medium">~</span>
                    <input type="number" id="rangeEnd" placeholder="20" class="w-14 px-1 py-1 border border-slate-300 rounded text-center focus:ring-2 focus:ring-indigo-500 outline-none" min="1">
                    <button id="selectRangeBtn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition-all font-bold shadow-sm whitespace-nowrap">é¸å–</button>
                </div>
            </div>
            <button id="copySelectedBtn" class="w-full md:w-auto shrink-0 bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-lg hover:bg-indigo-200 hover:shadow transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                è¤‡è£½é¸å–çš„é€£çµ (0)
            </button>
        </div>

        <!-- å½±ç‰‡çµæœå€å¡Š -->
        <div id="results" class="grid grid-cols-1 gap-3 mb-6"></div>

        <!-- é™¤éŒ¯é¢æ¿ -->
        <div class="bg-slate-800 rounded-xl p-4 shadow-inner">
            <div class="flex justify-between items-center mb-2">
                <span class="text-slate-300 font-mono text-sm font-bold">ğŸ› ï¸ ç³»çµ±åŸ·è¡Œæ—¥èªŒ (Debug Log)</span>
                <button onclick="document.getElementById('debugLog').innerHTML=''" class="text-slate-500 hover:text-slate-300 text-xs">æ¸…é™¤</button>
            </div>
            <pre id="debugLog" class="text-green-400 font-mono text-xs overflow-y-auto h-40 custom-scrollbar whitespace-pre-wrap"></pre>
        </div>
    </div>

    <!-- æ–°å¢ï¼šä½¿ç”¨èªªæ˜å½ˆå‡ºè¦–çª— (Modal) -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- é»‘è‰²åŠé€æ˜èƒŒæ™¯ -->
        <div id="helpModalBg" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm cursor-pointer transition-opacity duration-300 opacity-0"></div>
        
        <!-- è¦–çª—ä¸»é«” -->
        <div id="helpModalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg z-10 overflow-hidden transform transition-all duration-300 scale-95 opacity-0">
            <div class="bg-indigo-600 p-5 text-white flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">ğŸ“– å¦‚ä½•ä½¿ç”¨å½±ç‰‡æå–å™¨ï¼Ÿ</h2>
                <button class="close-help-btn hover:bg-indigo-500 p-1.5 rounded-lg transition-colors focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 space-y-5 text-slate-700">
                <div class="flex gap-4 items-start">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center flex-shrink-0 mt-0.5">1</div>
                    <div>
                        <h3 class="font-bold text-slate-800">è¤‡è£½ JW ç¶²å€</h3>
                        <p class="text-sm mt-1">å‰å¾€ JW.org çš„ã€Œåˆ†é¡ã€é é¢ï¼ˆç¶²å€ä¸­éœ€åŒ…å« <code class="bg-slate-100 text-pink-600 px-1 py-0.5 rounded text-xs">/categories/</code>ï¼‰ï¼Œä¸¦å°‡ä¸Šæ–¹ç¶²å€å®Œæ•´è¤‡è£½ä¸‹ä¾†ã€‚</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center flex-shrink-0 mt-0.5">2</div>
                    <div>
                        <h3 class="font-bold text-slate-800">è²¼ä¸Šä¸¦æå–</h3>
                        <p class="text-sm mt-1">å°‡ç¶²å€è²¼å…¥æœ¬å·¥å…·çš„è¼¸å…¥æ¡†ï¼Œé»æ“Šã€Œç«‹å³æå–å½±ç‰‡ã€ï¼Œç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨æƒæä¸¦æŠ“å‡ºæ‰€æœ‰å½±ç‰‡ã€‚</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center flex-shrink-0 mt-0.5">3</div>
                    <div>
                        <h3 class="font-bold text-slate-800">å‹¾é¸æƒ³è¦çš„å½±ç‰‡</h3>
                        <p class="text-sm mt-1">æ‚¨å¯ä»¥å–®ç¨é»æ“Šå¡ç‰‡ä¾†æ‰“å‹¾ï¼Œæˆ–è€…åˆ©ç”¨ä¸Šæ–¹çš„ã€Œå€é–“ã€å·¥å…·ï¼ˆä¾‹å¦‚è¼¸å…¥ 11~20ï¼‰ä¾†å¿«é€Ÿæ‰¹æ¬¡é¸å–ã€‚</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center flex-shrink-0 mt-0.5">4</div>
                    <div>
                        <h3 class="font-bold text-slate-800">ä¸€éµè¤‡è£½å¸¶èµ°</h3>
                        <p class="text-sm mt-1">é»æ“Šã€Œè¤‡è£½é¸å–çš„é€£çµã€æŒ‰éˆ•ï¼Œå°±æœƒè‡ªå‹•å¹«æ‚¨æ‰“åŒ…è¤‡è£½ï¼Œç›´æ¥å»å…¶ä»–åœ°æ–¹è²¼ä¸Šå³å¯ï¼</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-xs flex gap-2">
                    <span>ğŸ’¡</span>
                    <span><strong>æ³¨æ„ï¼š</strong>å¦‚æœæ˜¯ã€Œæœå°‹çµæœã€é é¢ï¼ˆç¶²å€åŒ…å« /search/ï¼‰ï¼Œå› ç‚ºç³»çµ±é™åˆ¶ç„¡æ³•åœ¨æ­¤æå–ï¼Œè«‹æ”¹ç”¨ç€è¦½å™¨ F12 é–‹ç™¼è€…å·¥å…·è…³æœ¬æå–ã€‚</span>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button class="close-help-btn bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors shadow-sm">æˆ‘çŸ¥é“äº†ï¼Œé–‹å§‹ä½¿ç”¨ï¼</button>
            </div>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const resultsContainer = document.getElementById('results');
        const statusBox = document.getElementById('statusBox');
        const debugLog = document.getElementById('debugLog');
        
        // é¸æ“‡é¢æ¿å…ƒç´ 
        const actionPanel = document.getElementById('actionPanel');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const copySelectedBtn = document.getElementById('copySelectedBtn');
        const rangeStart = document.getElementById('rangeStart');
        const rangeEnd = document.getElementById('rangeEnd');
        const selectRangeBtn = document.getElementById('selectRangeBtn');

        // --- æ–°å¢ï¼šä½¿ç”¨èªªæ˜ (Modal) é‚è¼¯ ---
        const helpModal = document.getElementById('helpModal');
        const helpModalBg = document.getElementById('helpModalBg');
        const helpModalContent = document.getElementById('helpModalContent');
        const showHelpBtn = document.getElementById('showHelpBtn');
        const closeHelpBtns = document.querySelectorAll('.close-help-btn');

        function openHelpModal() {
            helpModal.classList.remove('hidden');
            // å»¶é²ä¸€é»é»ä»¥è§¸ç™¼å‹•ç•«
            setTimeout(() => {
                helpModalBg.classList.remove('opacity-0');
                helpModalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeHelpModal() {
            helpModalBg.classList.add('opacity-0');
            helpModalContent.classList.add('opacity-0', 'scale-95');
            // è¨˜éŒ„å·²è®€å–ç‹€æ…‹åˆ°ç€è¦½å™¨ä¸­
            localStorage.setItem('jw_extractor_help_seen', 'true');
            // ç­‰å¾…å‹•ç•«çµæŸå¾Œéš±è—
            setTimeout(() => {
                helpModal.classList.add('hidden');
            }, 300);
        }

        showHelpBtn.addEventListener('click', openHelpModal);
        helpModalBg.addEventListener('click', closeHelpModal);
        closeHelpBtns.forEach(btn => btn.addEventListener('click', closeHelpModal));

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡é–‹å•Ÿ
        window.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('jw_extractor_help_seen')) {
                // å»¶é²åŠç§’å¾Œè‡ªå‹•å½ˆå‡ºï¼Œè¦–è¦ºæ•ˆæœæ›´å¥½
                setTimeout(openHelpModal, 500);
            }
        });

        // æ—¥èªŒç´€éŒ„åŠŸèƒ½
        function log(msg) {
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            debugLog.innerHTML += `[${time}] ${msg}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(msg);
        }

        // ğŸŒŸ å‡ç´šç‰ˆç¶²å€è§£æå™¨ï¼šæ”¯æ´æ¨™æº–è·¯å¾‘èˆ‡ Finder åˆ†äº«é€£çµ
        function parseJwUrl(url) {
            try {
                // 1. å˜—è©¦è§£æ Finder åˆ†äº«é€£çµ (å¸¶æœ‰ ?category=... åƒæ•¸)
                try {
                    // ç¢ºä¿ç¶²å€æœ‰ http é–‹é ­æ‰èƒ½è¢« URL ç‰©ä»¶è§£æ
                    const validUrl = url.startsWith('http') ? url : 'https://' + url;
                    const urlObj = new URL(validUrl);
                    const catParam = urlObj.searchParams.get('category');
                    const langParam = urlObj.searchParams.get('wtlocale') || urlObj.searchParams.get('locale');
                    
                    if (catParam) {
                        let finalLang = langParam;
                        // å¦‚æœåˆ†äº«é€£çµæ²’æœ‰å¸¶èªè¨€ï¼Œå˜—è©¦å¾è·¯å¾‘ä¸­æŠ“å–
                        if (!finalLang) {
                            const pathSegments = urlObj.pathname.split('/').filter(Boolean);
                            finalLang = pathSegments.find(s => s.includes('-')) || 'CH';
                        }
                        return { lang: finalLang, category: catParam };
                    }
                } catch(e) { /* è§£æå¤±æ•—å‰‡é€€å›åŸæœ¬çš„æ–¹æ³• */ }

                // 2. åŸæœ¬çš„ Hash æˆ–æ¨™æº–è·¯å¾‘è§£æé‚è¼¯
                const target = url.includes('#') ? url.split('#')[1] : url;
                // éæ¿¾æ‰ç„¡ç”¨çš„ç¶²å€ç‰‡æ®µ
                const segments = target.split('/').filter(s => 
                    s && s !== 'library' && s !== 'videos' && s !== 'https:' && s !== '' && !s.includes('www.jw.org')
                );
                
                const lang = segments.find(s => s.includes('-')) || segments[0];
                let category = '';
                const catIdx = segments.indexOf('categories');
                
                if (catIdx !== -1 && segments[catIdx + 1]) {
                    category = segments[catIdx + 1].split('?')[0]; // ç§»é™¤å°¾éƒ¨çš„åƒæ•¸
                } else if (segments.length > 0) {
                    category = segments[segments.length - 1].split('?')[0];
                }
                
                return (lang && category) ? { lang, category } : null;
            } catch (e) { 
                return null; 
            }
        }

        async function fetchVideos() {
            const params = parseJwUrl(urlInput.value.trim());
            if (!params) {
                log("âŒ è§£æç¶²å€å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€æ ¼å¼ã€‚");
                return showStatus('âŒ ç„¡æ³•è¾¨è­˜ç¶²å€æ ¼å¼', 'error');
            }

            setLoading(true);
            resultsContainer.innerHTML = '';
            actionPanel.classList.add('hidden'); // éš±è—é¢æ¿
            debugLog.innerHTML = ''; // æ¸…ç©ºæ—¥èªŒ
            showStatus('ğŸ” æ­£åœ¨é€£æ¥ API ä¼ºæœå™¨...', 'success');

            try {
                const { lang: parsedLang, category: rootCat } = params;
                log(`ğŸŒ ç¶²å€è§£ææˆåŠŸï¼šèªè¨€ = ${parsedLang}, åˆ†é¡ = ${rootCat}`);

                let uiLang = parsedLang;
                let apiLang = parsedLang;
                let allMedia = [];
                let checkedKeys = new Set();

                // æ­¥é©Ÿ 1: å‹•æ…‹ç²å– JW å…§éƒ¨èªè¨€ä»£ç¢¼èˆ‡é›™å‘è½‰æ›
                log(`ğŸ”„ æ­£åœ¨é€²è¡Œèªè¨€ä»£ç¢¼èˆ‡ä»‹é¢èªè¨€è½‰æ›...`);
                const knownLangs = {
                    'cmn-hant': 'CH', 'cmn-hans': 'CHS', 'en': 'E', 'ja': 'J', 
                    'ko': 'KO', 'es': 'S', 'fr': 'F', 'pt': 'T', 'de': 'X'
                };
                // å»ºç«‹åå‘å°æ‡‰è¡¨ (ä¾‹å¦‚ 'CH' -> 'cmn-hant')
                const reverseLangs = Object.fromEntries(Object.entries(knownLangs).map(([k, v]) => [v, k]));

                const inputLangLower = parsedLang.toLowerCase();
                const inputLangUpper = parsedLang.toUpperCase();

                if (knownLangs[inputLangLower]) {
                    apiLang = knownLangs[inputLangLower];
                    uiLang = inputLangLower;
                    log(`âœ… æª¢æ¸¬ç‚ºç¶²é èªè¨€ (UI Locale): ${uiLang} â APIä»£ç¢¼ ${apiLang}`);
                } else if (reverseLangs[inputLangUpper]) {
                    apiLang = inputLangUpper;
                    uiLang = reverseLangs[inputLangUpper];
                    log(`âœ… æª¢æ¸¬ç‚ºå…§éƒ¨ä»£ç¢¼ (API Code): ${apiLang} â ç¶²é èªè¨€ ${uiLang}`);
                } else {
                    log(`âš ï¸ æ‰¾ä¸åˆ°é è¨­å°æ‡‰ï¼Œå˜—è©¦ç·šä¸ŠæŸ¥è©¢...`);
                    try {
                        const langRes = await fetch('https://b.jw-cdn.org/apis/mediator/v1/languages/E/all');
                        if (langRes.ok) {
                            const langData = await langRes.json();
                            const langMatch = langData.languages.find(l => 
                                (l.locale && l.locale.toLowerCase() === inputLangLower) || 
                                (l.code && l.code.toUpperCase() === inputLangUpper)
                            );
                            if (langMatch) {
                                apiLang = langMatch.code;
                                uiLang = langMatch.locale || parsedLang;
                                log(`âœ… ç·šä¸Šå°æ‡‰æˆåŠŸ: APIä»£ç¢¼ = ${apiLang}, ç¶²é èªè¨€ = ${uiLang}`);
                            } else {
                                log(`âš ï¸ ç·šä¸Šæ‰¾ä¸åˆ°å°æ‡‰ï¼Œç¹¼çºŒä½¿ç”¨åŸå§‹ä»£ç¢¼: ${parsedLang}`);
                            }
                        }
                    } catch (e) {
                        log(`âš ï¸ èªè¨€æ¸…å–®ç²å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼: ${parsedLang}`);
                    }
                }

                // æ­¥é©Ÿ 2: æ·±åº¦æ¢æ¸¬å‡½æ•¸
                async function deepProbe(key) {
                    if (!key || checkedKeys.has(key) || allMedia.length >= 300) return;
                    checkedKeys.add(key);

                    const apiUrl = `https://b.jw-cdn.org/apis/mediator/v1/categories/${apiLang}/${key}?detailed=1&clientType=www`;
                    log(`â¡ï¸ æ­£åœ¨è«‹æ±‚è³‡æ–™: /${apiLang}/${key}`);
                    
                    try {
                        const res = await fetch(apiUrl);
                        if (!res.ok) {
                            log(`âŒ API å›å‚³å¤±æ•— (${res.status}): ${key}`);
                            return;
                        }
                        const data = await res.json();
                        const catData = data.category || data;

                        const items = catData.media || [];
                        log(`âœ… æ–¼ç›®éŒ„ ${key} ç™¼ç¾ ${items.length} å€‹åª’é«”é …ç›®`);
                        
                        items.forEach(v => {
                            if (v.type === 'video' && allMedia.length < 300) {
                                allMedia.push({
                                    title: v.title,
                                    guid: v.languageAgnosticNaturalKey,
                                    originCat: key
                                });
                            }
                        });

                        const children = catData.subcategories || catData.subdivisions || [];
                        if (children.length > 0) log(`ğŸ“‚ ç™¼ç¾ ${children.length} å€‹å­ç›®éŒ„ï¼Œæº–å‚™éæ­¸...`);
                        
                        for (const child of children) {
                            const nextKey = child.key || child.id;
                            if (nextKey && allMedia.length < 300) {
                                await deepProbe(nextKey);
                            }
                        }
                    } catch (e) { log(`ğŸ’¥ è«‹æ±‚è§£æéŒ¯èª¤: ${e.message}`); }
                }

                // æ­¥é©Ÿ 3: é–‹å§‹æ¢æ¸¬
                await deepProbe(rootCat);
                
                if (allMedia.length === 0 && rootCat.toLowerCase().includes('monthly')) {
                    const year = new Date().getFullYear();
                    log(`âš ï¸ é¦–é¸è·¯å¾‘ç„¡å½±ç‰‡ï¼Œå•Ÿå‹•å‚™ç”¨æ¢æ¸¬...`);
                    await deepProbe(`StudioMonthlyPrograms${year}`);
                    await deepProbe(`VODMonthlyPrograms${year}`);
                    if (allMedia.length === 0) await deepProbe(`StudioMonthlyPrograms${year-1}`);
                }

                // å»é‡
                const unique = [];
                const seen = new Set();
                allMedia.forEach(v => {
                    if (!seen.has(v.guid)) {
                        seen.add(v.guid);
                        unique.push(v);
                    }
                });

                if (unique.length === 0) {
                    log(`âŒ æœ€çµ‚çµæœï¼šæ‰¾ä¸åˆ°ä»»ä½•å½±ç‰‡ã€‚`);
                    showStatus('ğŸ” æ‰¾ä¸åˆ°å½±ç‰‡ã€‚è«‹æŸ¥çœ‹ä¸‹æ–¹æ—¥èªŒäº†è§£åŸå› ã€‚', 'error');
                } else {
                    log(`ğŸ‰ è™•ç†å®Œæˆï¼å…±æå– ${unique.length} å‰‡ä¸é‡è¤‡å½±ç‰‡ã€‚`);
                    displayVideos(unique.slice(0, 300), uiLang, rootCat);
                    showStatus(`âœ… æˆåŠŸæ‰¾åˆ° ${unique.length} å‰‡å½±ç‰‡`, 'success');
                    
                    // é¡¯ç¤ºæ“ä½œé¢æ¿ä¸¦é è¨­å…¨é¸
                    actionPanel.classList.remove('hidden');
                    selectAllCheckbox.checked = true;
                    updateSelectionState(); 
                }
            } catch (e) {
                log(`ğŸ’¥ ç³»çµ±ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤: ${e.message}`);
                showStatus('ğŸ’¥ é€£ç·šè¶…æ™‚ï¼Œè«‹é‡è©¦', 'error');
            } finally {
                setLoading(false);
            }
        }

        function displayVideos(videos, lang, rootCat) {
            videos.forEach((v, i) => {
                const videoUrl = `https://www.jw.org/${lang}/library/videos/#/${lang}/mediaitems/${rootCat}/${v.guid}`;
                const div = document.createElement('div');
                div.className = "video-card bg-white p-3 pr-4 rounded-xl shadow-sm border border-slate-200 flex items-center gap-3 cursor-pointer hover:border-indigo-300";
                div.onclick = (e) => {
                    if(e.target.closest('button') || e.target.closest('a')) return;
                    const cb = div.querySelector('.video-cb');
                    cb.checked = !cb.checked;
                    updateSelectionState();
                };

                div.innerHTML = `
                    <div class="flex items-center pl-2">
                        <input type="checkbox" value="${videoUrl}" class="video-cb w-5 h-5 rounded border-slate-300 cursor-pointer pointer-events-none" checked>
                    </div>
                    <div class="w-7 h-7 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">${i+1}</div>
                    <div class="flex-grow min-w-0 pl-1">
                        <div class="font-bold text-slate-800 truncate text-sm">${v.title}</div>
                        <div class="text-[10px] text-slate-400 font-mono mt-0.5">ä¾†è‡ª: ${v.originCat}</div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="copyToClipboard('${videoUrl}')" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors bg-slate-50 rounded-lg hover:bg-indigo-50" title="å–®ç¨è¤‡è£½æ­¤é€£çµ"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                        <a href="${videoUrl}" target="_blank" class="p-2 text-slate-400 hover:text-emerald-600 transition-colors bg-slate-50 rounded-lg hover:bg-emerald-50" title="å‰å¾€ç¶²é æ¸¬è©¦"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg></a>
                    </div>
                `;
                resultsContainer.appendChild(div);
            });
        }

        // --- å‹¾é¸èˆ‡è¤‡è£½é‚è¼¯ ---

        // å…¨é¸ / å–æ¶ˆå…¨é¸ äº‹ä»¶ (ä¿®æ­£ï¼šåªæŠ“ #results è£¡é¢çš„æ‰“å‹¾æ¡†)
        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('#results .video-cb');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateSelectionState();
        });

        // ç›£è½å€‹åˆ¥å‹¾é¸æ¡†è®ŠåŒ–
        resultsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('video-cb')) {
                updateSelectionState();
            }
        });

        // å€é–“é¸å–äº‹ä»¶ (ä¿®æ­£ï¼šåªæŠ“ #results è£¡é¢çš„æ‰“å‹¾æ¡†ï¼Œé¿å…é¸åˆ°å…¨é¸æ¡†)
        selectRangeBtn.onclick = () => {
            const start = parseInt(rangeStart.value);
            const end = parseInt(rangeEnd.value);
            const checkboxes = document.querySelectorAll('#results .video-cb');
            const total = checkboxes.length;
            
            if (isNaN(start) || isNaN(end) || start < 1 || end > total || start > end) {
                alert(`âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„å€é–“ç¯„åœï¼\nç›®å‰å¯é¸ç¯„åœï¼š1 åˆ° ${total}`);
                return;
            }

            // æ¸…ç©ºç¾æœ‰å‹¾é¸
            checkboxes.forEach(cb => cb.checked = false);
            
            // å‹¾é¸æŒ‡å®šå€é–“ (é™£åˆ—ç´¢å¼•å¾ 0 é–‹å§‹ï¼Œæ‰€ä»¥ start - 1)
            for (let i = start - 1; i < end; i++) {
                if (checkboxes[i]) checkboxes[i].checked = true;
            }
            
            updateSelectionState();
            log(`ğŸ¯ å·²è‡ªå‹•é¸å–ç¬¬ ${start} åˆ° ${end} å€‹å½±ç‰‡ã€‚`);
        };

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ (ä¿®æ­£ï¼šåªæŠ“ #results è£¡é¢çš„æ‰“å‹¾æ¡†)
        function updateSelectionState() {
            const checkboxes = document.querySelectorAll('#results .video-cb');
            const checkedCount = document.querySelectorAll('#results .video-cb:checked').length;
            
            // æ›´æ–°å…¨é¸æ¡†ç‹€æ…‹
            selectAllCheckbox.checked = (checkedCount === checkboxes.length && checkboxes.length > 0);
            selectAllCheckbox.indeterminate = (checkedCount > 0 && checkedCount < checkboxes.length);

            // æ›´æ–°æŒ‰éˆ•æ–‡å­—èˆ‡ç¦ç”¨ç‹€æ…‹
            if (checkedCount > 0) {
                copySelectedBtn.innerText = `è¤‡è£½é¸å–çš„é€£çµ (${checkedCount})`;
                copySelectedBtn.disabled = false;
                copySelectedBtn.classList.replace('bg-slate-100', 'bg-indigo-100');
                copySelectedBtn.classList.replace('text-slate-400', 'text-indigo-700');
            } else {
                copySelectedBtn.innerText = `è«‹é¸æ“‡å½±ç‰‡`;
                copySelectedBtn.disabled = true;
                copySelectedBtn.classList.replace('bg-indigo-100', 'bg-slate-100');
                copySelectedBtn.classList.replace('text-indigo-700', 'text-slate-400');
            }
        }

        // è¤‡è£½æŒ‰éˆ•é»æ“Šäº‹ä»¶ (ä¿®æ­£ï¼šåªæŠ“ #results è£¡é¢çš„æ‰“å‹¾æ¡†)
        copySelectedBtn.onclick = () => {
            const checkedBoxes = document.querySelectorAll('#results .video-cb:checked');
            if (checkedBoxes.length === 0) return;
            
            const links = Array.from(checkedBoxes).map(cb => cb.value).join('\n');
            copyToClipboard(links, checkedBoxes.length);
        };

        // å…±ç”¨å·¥å…·å‡½æ•¸
        function setLoading(l) {
            fetchBtn.disabled = l;
            fetchBtn.innerHTML = l ? '<span class="scanning">ç¶²è·¯æ¢æ¸¬ä¸­...</span>' : 'ç«‹å³æå–å½±ç‰‡';
        }

        function showStatus(m, t) {
            statusBox.innerText = m;
            statusBox.className = `mb-6 p-4 rounded-xl text-center font-medium ${t==='success'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-rose-50 text-rose-700 border-rose-100'}`;
            statusBox.classList.remove('hidden');
        }

        function copyToClipboard(t, count = 1) {
            const el = document.createElement('textarea');
            el.value = t; document.body.appendChild(el);
            el.select(); document.execCommand('copy');
            document.body.removeChild(el);
            
            const oldText = copySelectedBtn.innerText;
            const originalClass = copySelectedBtn.className;
            
            copySelectedBtn.innerText = `âœ¨ æˆåŠŸè¤‡è£½ ${count} å€‹é€£çµï¼`;
            copySelectedBtn.className = 'bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-md';
            
            setTimeout(() => {
                copySelectedBtn.innerText = oldText;
                copySelectedBtn.className = originalClass;
            }, 2000);
        }

        fetchBtn.onclick = fetchVideos;
    </script>
</body>
</html>
